<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Graph Intelligence ‚Äî GST Recon Engine</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .graph-container {
            position: relative;
            width: 100%;
            height: calc(100vh - 180px);
            min-height: 500px;
            background: radial-gradient(ellipse at center, rgba(99, 102, 241, 0.03) 0%, transparent 70%);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            overflow: hidden;
        }

        .graph-container svg {
            width: 100%;
            height: 100%;
        }

        .graph-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 10;
        }

        .graph-controls button {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(15, 15, 30, 0.9);
            color: white;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .graph-controls button:hover {
            background: rgba(99, 102, 241, 0.3);
            border-color: rgba(99, 102, 241, 0.5);
        }

        .node-tooltip {
            position: absolute;
            background: rgba(10, 10, 25, 0.95);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 12px;
            padding: 15px;
            color: white;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 320px;
            backdrop-filter: blur(20px);
            z-index: 100;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .node-tooltip.visible {
            opacity: 1;
        }

        .node-tooltip h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: var(--accent-light);
        }

        .node-tooltip .tt-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        }

        .node-tooltip .tt-label {
            color: var(--text-dim);
        }

        .node-tooltip .tt-value {
            font-weight: 600;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-chip {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 12px 16px;
            text-align: center;
        }

        .stat-chip .num {
            font-size: 22px;
            font-weight: 800;
            letter-spacing: -1px;
        }

        .stat-chip .lbl {
            font-size: 10px;
            color: var(--text-dim);
            letter-spacing: 1px;
            margin-top: 4px;
        }

        .legend-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-dim);
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .search-box {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px 15px;
            color: white;
            font-family: 'Outfit';
            font-size: 13px;
            width: 280px;
        }

        .search-box::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        /* Detail panel */
        .detail-panel {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background: rgba(10, 10, 25, 0.95);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 14px;
            padding: 20px;
            max-width: 350px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 10;
            display: none;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .detail-panel.visible {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .detail-panel h4 {
            margin: 0 0 12px 0;
            font-size: 14px;
            color: var(--accent-light);
        }

        .risk-chip {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .risk-LOW {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }

        .risk-MEDIUM {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }

        .risk-HIGH {
            background: rgba(244, 63, 94, 0.15);
            color: #f43f5e;
        }

        .risk-CRITICAL {
            background: rgba(139, 0, 0, 0.3);
            color: #ff4444;
        }

        .rule-list {
            margin-top: 10px;
        }

        .rule-item {
            padding: 8px 10px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            margin-bottom: 6px;
            font-size: 11px;
            border-left: 3px solid var(--accent-light);
        }

        .rule-item .rule-id {
            font-weight: 700;
            color: var(--accent-light);
        }

        .rule-item .rule-pts {
            float: right;
            color: var(--danger);
            font-weight: 700;
        }

        .empty-state {
            text-align: center;
            padding: 100px 40px;
            color: var(--text-dim);
        }

        .empty-state .icon {
            font-size: 50px;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            color: white;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <div class="app-layout">
        <aside class="sidebar" id="sidebar"></aside>

        <main class="main-content">
            <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:25px">
                <div>
                    <h1 style="margin:0;font-size:28px;letter-spacing:-1px">Knowledge Graph Intelligence</h1>
                    <p style="color:var(--text-dim);margin:5px 0 0 0">Transaction network analysis & fraud detection</p>
                </div>
                <div style="display:flex;gap:12px;align-items:center">
                    <input type="text" class="search-box" id="gstin-search" placeholder="üîç Search GSTIN...">
                    <button class="btn" id="refresh-btn"
                        style="background:rgba(255,255,255,0.05);box-shadow:none;border:1px solid rgba(255,255,255,0.1)">REFRESH</button>
                </div>
            </header>

            <!-- Loading State -->
            <div id="loading-state" style="text-align:center; padding: 80px 40px;">
                <div style="font-size:40px; margin-bottom:20px;">üï∏Ô∏è</div>
                <p style="font-size:18px; font-weight:500; color: var(--accent-light);">Building Knowledge Graph...</p>
                <p style="color:var(--text-dim); font-size:14px; margin-top:10px;">Constructing transaction network and
                    detecting patterns</p>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="empty-state" style="display:none;">
                <div class="icon">üì≠</div>
                <h3>No Graph Data Available</h3>
                <p>Upload GSTR files from the Dashboard to start building your transaction network.</p>
            </div>

            <!-- Main Content (hidden until loaded) -->
            <div id="graph-content" style="display:none">
                <!-- Stats Bar -->
                <div class="stats-bar" id="stats-bar">
                    <div class="stat-chip">
                        <div class="num" id="stat-nodes" style="color:var(--accent-light)">0</div>
                        <div class="lbl">ENTITIES</div>
                    </div>
                    <div class="stat-chip">
                        <div class="num" id="stat-edges" style="color:#10b981">0</div>
                        <div class="lbl">CONNECTIONS</div>
                    </div>
                    <div class="stat-chip">
                        <div class="num" id="stat-registered" style="color:#f59e0b">0</div>
                        <div class="lbl">REGISTERED</div>
                    </div>
                    <div class="stat-chip">
                        <div class="num" id="stat-external" style="color:var(--text-dim)">0</div>
                        <div class="lbl">EXTERNAL</div>
                    </div>
                    <div class="stat-chip">
                        <div class="num" id="stat-cycles" style="color:var(--danger)">0</div>
                        <div class="lbl">CYCLES</div>
                    </div>
                </div>

                <!-- Legend -->
                <div class="legend-bar">
                    <div class="legend-item">
                        <div class="legend-dot" style="background:#10b981"></div> Low Risk
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background:#f59e0b"></div> Medium Risk
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background:#f43f5e"></div> High Risk
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background:#1a1a2e;border:2px solid #f43f5e"></div> Critical /
                        Cycle
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot"
                            style="background:rgba(99,102,241,0.3);border:2px solid var(--accent-light)"></div> Your
                        GSTIN
                    </div>
                </div>

                <!-- Graph Container -->
                <div class="graph-container" id="graph-container">
                    <svg id="graph-svg"></svg>

                    <div class="graph-controls">
                        <button id="zoom-in" title="Zoom In">+</button>
                        <button id="zoom-out" title="Zoom Out">‚àí</button>
                        <button id="zoom-fit" title="Fit to View">‚ä°</button>
                        <button id="toggle-labels" title="Toggle Labels">Aa</button>
                    </div>

                    <div class="node-tooltip" id="node-tooltip"></div>
                    <div class="detail-panel" id="detail-panel"></div>
                </div>
            </div>

            <!-- Error Display -->
            <div id="error-display"
                style="display:none; color: var(--danger); background: rgba(244, 63, 94, 0.1); padding: 20px; border-radius: 12px; margin-top: 20px; border: 1px solid var(--danger);">
                <p style="margin: 0"><strong>Graph Build Error:</strong> <span id="error-text"></span></p>
            </div>
        </main>

        <aside class="right-bar">
            <h3 style="font-size:14px; color:var(--text-dim); margin-bottom:20px; letter-spacing:1px;">FRAUD INTEL</h3>

            <div id="fraud-summary-panel">
                <div class="card"
                    style="padding:15px; margin-bottom:12px; background:rgba(16, 185, 129, 0.05); border-color:rgba(16, 185, 129, 0.2);">
                    <div style="font-size:10px; color:#10b981; font-weight:700; margin-bottom:5px;">LOW RISK</div>
                    <div style="font-size:20px; font-weight:700;" id="fraud-low">0</div>
                </div>
                <div class="card"
                    style="padding:15px; margin-bottom:12px; background:rgba(245, 158, 11, 0.05); border-color:rgba(245, 158, 11, 0.2);">
                    <div style="font-size:10px; color:#f59e0b; font-weight:700; margin-bottom:5px;">MEDIUM RISK</div>
                    <div style="font-size:20px; font-weight:700;" id="fraud-medium">0</div>
                </div>
                <div class="card"
                    style="padding:15px; margin-bottom:12px; background:rgba(244, 63, 94, 0.05); border-color:rgba(244, 63, 94, 0.2);">
                    <div style="font-size:10px; color:#f43f5e; font-weight:700; margin-bottom:5px;">HIGH RISK</div>
                    <div style="font-size:20px; font-weight:700;" id="fraud-high">0</div>
                </div>
                <div class="card"
                    style="padding:15px; margin-bottom:12px; background:rgba(139, 0, 0, 0.1); border-color:rgba(200, 0, 0, 0.2);">
                    <div style="font-size:10px; color:#ff4444; font-weight:700; margin-bottom:5px;">CRITICAL</div>
                    <div style="font-size:20px; font-weight:700;" id="fraud-critical">0</div>
                </div>
            </div>

            <div style="flex:1"></div>

            <div id="cycles-panel"
                style="padding:15px; background:rgba(255,255,255,0.02); border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                <div style="font-size:10px; color:var(--text-dim); letter-spacing:1px; margin-bottom:8px;">CIRCULAR
                    TRADING</div>
                <div style="font-size:14px; font-weight:600;" id="cycles-info">No cycles detected</div>
            </div>
        </aside>
    </div>

    <script src="js/config.js"></script>
    <script type="module">
        import { api, requireAuth } from './js/api.js';
        import { initSidebar, initHeader } from './js/shared.js';

        let graphData = null;
        let showLabels = true;

        async function start() {
            const authenticated = await requireAuth();
            if (!authenticated) return;

            initSidebar('graph');
            initHeader(api);

            document.getElementById('refresh-btn').onclick = () => loadGraph();
            document.getElementById('gstin-search').addEventListener('input', handleSearch);

            await loadGraph();
        }

        async function loadGraph() {
            const loading = document.getElementById('loading-state');
            const content = document.getElementById('graph-content');
            const empty = document.getElementById('empty-state');
            const error = document.getElementById('error-display');

            loading.style.display = 'block';
            content.style.display = 'none';
            empty.style.display = 'none';
            error.style.display = 'none';

            try {
                const data = await api.getUserGraph();
                graphData = data;

                const g = data.graph;
                if (!g || !g.nodes || g.nodes.length === 0) {
                    loading.style.display = 'none';
                    empty.style.display = 'block';
                    return;
                }

                // Update stats
                document.getElementById('stat-nodes').textContent = g.stats.total_nodes;
                document.getElementById('stat-edges').textContent = g.stats.total_edges;
                document.getElementById('stat-registered').textContent = g.stats.registered_nodes;
                document.getElementById('stat-external').textContent = g.stats.external_nodes;
                document.getElementById('stat-cycles').textContent = g.stats.cycles;

                // Update fraud sidebar
                const fs = data.fraud_summary || {};
                document.getElementById('fraud-low').textContent = fs.LOW || 0;
                document.getElementById('fraud-medium').textContent = fs.MEDIUM || 0;
                document.getElementById('fraud-high').textContent = fs.HIGH || 0;
                document.getElementById('fraud-critical').textContent = fs.CRITICAL || 0;

                // Cycles
                const cycles = data.cycles || [];
                if (cycles.length > 0) {
                    document.getElementById('cycles-info').innerHTML =
                        `<span style="color:var(--danger)">${cycles.length} cycle(s)</span> detected`;
                }

                loading.style.display = 'none';
                content.style.display = 'block';

                renderGraph(g);

            } catch (err) {
                console.error('Graph Load Error:', err);
                loading.style.display = 'none';
                error.style.display = 'block';
                document.getElementById('error-text').textContent = err.message;
            }
        }

        function renderGraph(data) {
            const container = document.getElementById('graph-container');
            const svg = d3.select('#graph-svg');
            svg.selectAll('*').remove();

            const width = container.clientWidth;
            const height = container.clientHeight;

            svg.attr('viewBox', [0, 0, width, height]);

            // Zoom
            const g = svg.append('g');
            const zoom = d3.zoom()
                .scaleExtent([0.1, 8])
                .on('zoom', (event) => g.attr('transform', event.transform));
            svg.call(zoom);

            // Zoom controls
            document.getElementById('zoom-in').onclick = () => svg.transition().duration(300).call(zoom.scaleBy, 1.3);
            document.getElementById('zoom-out').onclick = () => svg.transition().duration(300).call(zoom.scaleBy, 0.7);
            document.getElementById('zoom-fit').onclick = () => svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity);
            document.getElementById('toggle-labels').onclick = () => {
                showLabels = !showLabels;
                g.selectAll('.node-label').style('display', showLabels ? 'block' : 'none');
            };

            // Arrow marker
            svg.append('defs').append('marker')
                .attr('id', 'arrowhead')
                .attr('viewBox', '0 -5 10 10')
                .attr('refX', 20)
                .attr('refY', 0)
                .attr('markerWidth', 6)
                .attr('markerHeight', 6)
                .attr('orient', 'auto')
                .append('path')
                .attr('d', 'M0,-5L10,0L0,5')
                .attr('fill', 'rgba(255,255,255,0.3)');

            // Simulation
            const simulation = d3.forceSimulation(data.nodes)
                .force('link', d3.forceLink(data.edges).id(d => d.id).distance(120))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(d => d.size + 10));

            // Edges
            const link = g.append('g')
                .selectAll('line')
                .data(data.edges)
                .join('line')
                .attr('stroke', d => d.color || 'rgba(255,255,255,0.1)')
                .attr('stroke-width', d => d.width || 1.5)
                .attr('stroke-dasharray', d => d.is_circular ? '6,3' : 'none')
                .attr('marker-end', 'url(#arrowhead)')
                .attr('opacity', 0.6);

            // Edge labels
            const edgeLabel = g.append('g')
                .selectAll('text')
                .data(data.edges)
                .join('text')
                .text(d => d.invoice_count > 1 ? `${d.invoice_count} inv` : '')
                .attr('font-size', 9)
                .attr('fill', 'rgba(255,255,255,0.3)')
                .attr('text-anchor', 'middle');

            // Nodes group
            const node = g.append('g')
                .selectAll('g')
                .data(data.nodes)
                .join('g')
                .call(d3.drag()
                    .on('start', (event, d) => {
                        if (!event.active) simulation.alphaTarget(0.3).restart();
                        d.fx = d.x; d.fy = d.y;
                    })
                    .on('drag', (event, d) => { d.fx = event.x; d.fy = event.y; })
                    .on('end', (event, d) => {
                        if (!event.active) simulation.alphaTarget(0);
                        d.fx = null; d.fy = null;
                    }));

            // Node circle glow (for primary)
            node.filter(d => d.is_primary)
                .append('circle')
                .attr('r', d => d.size + 8)
                .attr('fill', 'none')
                .attr('stroke', 'rgba(99, 102, 241, 0.3)')
                .attr('stroke-width', 2)
                .attr('stroke-dasharray', '4,4')
                .style('animation', 'pulse 2s infinite');

            // Node circles
            node.append('circle')
                .attr('r', d => d.size)
                .attr('fill', d => {
                    if (d.is_primary) return 'rgba(99, 102, 241, 0.3)';
                    if (d.in_cycle) return '#1a1a2e';
                    return d.color + '22';
                })
                .attr('stroke', d => {
                    if (d.is_primary) return '#6366f1';
                    if (d.in_cycle) return '#f43f5e';
                    return d.color;
                })
                .attr('stroke-width', d => d.is_primary ? 3 : d.in_cycle ? 2.5 : 1.5);

            // Node labels
            node.append('text')
                .attr('class', 'node-label')
                .text(d => {
                    if (d.is_primary) return '‚òÖ ' + d.label;
                    if (d.is_registered) return d.label;
                    return d.id.substring(0, 8) + '...';
                })
                .attr('font-size', d => d.is_primary ? 11 : 9)
                .attr('fill', d => d.is_primary ? '#6366f1' : 'rgba(255,255,255,0.6)')
                .attr('font-weight', d => d.is_primary ? 700 : 400)
                .attr('text-anchor', 'middle')
                .attr('dy', d => d.size + 14);

            // Node type icon (inside circle)
            node.append('text')
                .text(d => {
                    if (d.is_primary) return 'üè¢';
                    if (d.is_registered) return '‚úì';
                    return '?';
                })
                .attr('font-size', d => d.size > 20 ? 14 : 10)
                .attr('text-anchor', 'middle')
                .attr('dy', 4)
                .attr('fill', d => d.is_primary ? 'white' : d.color);

            // Tooltip
            const tooltip = document.getElementById('node-tooltip');
            node.on('mouseover', (event, d) => {
                const val = v => v ? '‚Çπ' + Number(v).toLocaleString('en-IN') : '‚Çπ0';
                tooltip.innerHTML = `
                    <h4>${d.label}</h4>
                    <div class="tt-row"><span class="tt-label">GSTIN</span><span class="tt-value">${d.id}</span></div>
                    <div class="tt-row"><span class="tt-label">Type</span><span class="tt-value">${d.type.replace('_', ' ')}</span></div>
                    <div class="tt-row"><span class="tt-label">Risk</span><span class="tt-value risk-${d.risk_level}">${d.risk_level} (${d.risk_score})</span></div>
                    <div class="tt-row"><span class="tt-label">Supplied</span><span class="tt-value">${val(d.supplied)}</span></div>
                    <div class="tt-row"><span class="tt-label">Received</span><span class="tt-value">${val(d.received)}</span></div>
                    <div class="tt-row"><span class="tt-label">Invoices Out</span><span class="tt-value">${d.inv_count_supplier}</span></div>
                    <div class="tt-row"><span class="tt-label">Invoices In</span><span class="tt-value">${d.inv_count_buyer}</span></div>
                    ${d.in_cycle ? '<div style="margin-top:8px;color:#f43f5e;font-weight:700;">‚ö†Ô∏è CIRCULAR TRADE DETECTED</div>' : ''}
                `;
                tooltip.classList.add('visible');
                tooltip.style.left = (event.pageX - container.getBoundingClientRect().left + 15) + 'px';
                tooltip.style.top = (event.pageY - container.getBoundingClientRect().top - 10) + 'px';
            })
                .on('mouseout', () => tooltip.classList.remove('visible'))
                .on('click', async (event, d) => {
                    event.stopPropagation();
                    await showNodeDetail(d.id);
                });

            // Tick
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                edgeLabel
                    .attr('x', d => (d.source.x + d.target.x) / 2)
                    .attr('y', d => (d.source.y + d.target.y) / 2);

                node.attr('transform', d => `translate(${d.x},${d.y})`);
            });

            // Close detail panel on SVG click
            svg.on('click', () => {
                document.getElementById('detail-panel').classList.remove('visible');
            });
        }

        async function showNodeDetail(gstin) {
            const panel = document.getElementById('detail-panel');
            panel.innerHTML = '<p style="color:var(--text-dim);font-size:12px;">Loading risk report...</p>';
            panel.classList.add('visible');

            try {
                const risk = await api.getEntityRisk(gstin);
                const val = v => '‚Çπ' + Number(v || 0).toLocaleString('en-IN');

                let rulesHTML = '';
                if (risk.detected_patterns && risk.detected_patterns.length > 0) {
                    rulesHTML = '<div class="rule-list">' +
                        risk.detected_patterns.map(p => `
                            <div class="rule-item">
                                <span class="rule-id">${p.rule_id}</span>
                                <span class="rule-pts">+${p.points} pts</span>
                                <div style="margin-top:4px;color:var(--text-dim)">${p.explanation}</div>
                            </div>
                        `).join('') +
                        '</div>';
                } else {
                    rulesHTML = '<p style="font-size:11px;color:var(--text-dim);margin-top:10px;">No fraud patterns detected.</p>';
                }

                panel.innerHTML = `
                    <h4>${risk.entity_id}</h4>
                    <div style="margin-bottom:10px">
                        <span class="risk-chip risk-${risk.risk_level}">${risk.risk_level}</span>
                        <span style="margin-left:8px;font-size:20px;font-weight:800;">${risk.risk_score}</span>
                        <span style="color:var(--text-dim);font-size:11px;">/100</span>
                    </div>
                    <div class="tt-row"><span class="tt-label">Invoices</span><span class="tt-value">${risk.total_invoices}</span></div>
                    <div class="tt-row"><span class="tt-label">Supplied</span><span class="tt-value">${val(risk.total_supplied)}</span></div>
                    <div class="tt-row"><span class="tt-label">Received</span><span class="tt-value">${val(risk.total_received)}</span></div>
                    <div class="tt-row"><span class="tt-label">Connected</span><span class="tt-value">${risk.connected_entities.length} entities</span></div>
                    ${risk.cycle_detected ? '<div style="margin-top:8px;padding:6px 10px;background:rgba(244,63,94,0.1);border-radius:8px;color:#f43f5e;font-size:11px;font-weight:700;">‚ö†Ô∏è CIRCULAR TRADING DETECTED</div>' : ''}
                    ${rulesHTML}
                `;
            } catch (err) {
                panel.innerHTML = `<p style="color:var(--danger);font-size:12px;">${err.message}</p>`;
            }
        }

        function handleSearch(e) {
            const query = e.target.value.trim().toUpperCase();
            if (!query) {
                d3.selectAll('circle').attr('opacity', 1);
                d3.selectAll('line').attr('opacity', 0.6);
                return;
            }

            d3.selectAll('g > g > g').each(function (d) {
                const match = d.id.includes(query) || (d.label && d.label.toUpperCase().includes(query));
                d3.select(this).selectAll('circle').attr('opacity', match ? 1 : 0.15);
                d3.select(this).selectAll('text').attr('opacity', match ? 1 : 0.15);
            });
        }

        // Handle logout
        document.addEventListener('click', (e) => {
            if (e.target && e.target.id === 'logout-btn') api.logout();
        });

        start();
    </script>
</body>

</html>